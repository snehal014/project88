AWSTemplateFormatVersion: 2010-09-09
Description: Create an EMR Cluster and download data from Kaggle

Resources:
  MyEMRCluster:
    Type: AWS::EMR::Cluster
    Properties:
      Name: MyEMRCluster
      ReleaseLabel: emr-6.4.0  # Use the appropriate EMR release version
      Instances:
        MasterInstanceGroup:
          InstanceCount: 1
          InstanceType: m5.xlarge
        CoreInstanceGroup:
          InstanceCount: 2
          InstanceType: m5.xlarge
        TerminationProtected: false
      Applications:
        - Name: Hadoop
        - Name: Spark
      LogUri: !Sub 's3://${LogBucket}/logs/'
      JobFlowRole: EMR_EC2_DefaultRole
      ServiceRole: EMR_DefaultRole
      Steps:
        - Name: Download Kaggle Data
          ActionOnFailure: TERMINATE_CLUSTER
          HadoopJarStep:
            Jar: command-runner.jar
            Args:
              - hive-script
              - !Sub |
                curl -L -o /home/hadoop/dataset.zip 'https://www.kaggle.com/datasets/username/dataset/download'
                unzip /home/hadoop/dataset.zip -d /home/hadoop/
      BootstrapActions:
        - Name: Install Kaggle CLI
          ScriptBootstrapAction:
            Path: !Sub 's3://${ScriptBucket}/install_kaggle_cli.sh'
            Args: []
            
  LogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: my-emr-logs-bucket-unique  # Ensure this bucket name is unique

  ScriptBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: my-emr-scripts-bucket-unique  # Ensure this bucket name is unique
